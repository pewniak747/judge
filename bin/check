#!/bin/bash

TIMELIMIT=1
TMP_DIR=tmp
PROGRAM_NAME=$1
FILE=$2
PROGRAM_DIR="problems/$PROGRAM_NAME"
PROGRAM="$TMP_DIR/$PROGRAM_NAME"
IN_DIR="$PROGRAM_DIR/in"
OUT_DIR="$PROGRAM_DIR/out"

source $PROGRAM_DIR/$PROGRAM_NAME.conf

infile=$IN_DIR/$FILE
outfile=`echo $OUT_DIR/${FILE/.in/.out}`
tempoutfile="$TMP_DIR/$FILE.tmp"
tempfile=$TMP_DIR/tmp
/usr/bin/time -o $tempfile -f "%U" $PROGRAM < $infile > $tempoutfile &
time_pid=$!
prog_pid=`pgrep -P $time_pid`
(sleep $TIMELIMIT; kill $prog_pid > /dev/null 2>&1) &
wait $time_pid > /dev/null 2>&1
time=`cat $tempfile | grep -o '[0-9]*\.[0-9]*'`
diff -q $outfile $tempoutfile > /dev/null
if [ $? -eq '0' ]; then
  result=0
else
  result=1
fi
if [[ $TIMELIMIT != 0 ]]; then
  if [[ $TIMELIMIT < $time ]]; then
    result=3
  fi
fi
echo $time > $TMP_DIR/time

exit $result
